<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-black">
<head>
    <meta charset="UTF-8">
    <title>Kael POS - New Order</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script>
        // Simple route protection
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = '/login.html';
        }
    </script>
    <style>
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        /* Custom styling for select dropdown arrow */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
        }
         /* Hide default number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="p-6 md:p-10 antialiased">

    <div class="max-w-4xl mx-auto bg-white border-4 border-black shadow-[10px_10px_0_0_#000]">

        <div class="bg-black text-white p-4 border-b-4 border-black flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                <span class="text-2xl">ðŸ›’</span> Kael POS - New Material Order
            </h1>
            <button id="logoutButton" class="bg-red-500 text-white font-bold py-1 px-3 border-2 border-black shadow-[2px_2px_0_0_#000] hover:bg-red-400 active:shadow-[1px_1px_0_0_#000] active:translate-x-[1px] active:translate-y-[1px] transition-all duration-150 text-sm">
                Logout
            </button>
        </div>

        <div class="p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-8">

            <div class="border-4 border-black shadow-[6px_6px_0_0_#000] bg-amber-50 p-6">
                <h2 class="text-xl font-bold mb-6 border-b-2 border-black pb-2">Order Details</h2>
                <form id="orderForm" class="space-y-6">
                    <div>
                        <label for="materialSelect" class="block text-sm font-bold text-black mb-1">1. Select Material</label>
                        <select id="materialSelect" class="w-full border-2 border-black bg-white px-4 py-3 font-medium focus:outline-none focus:ring-4 focus:ring-offset-0 focus:ring-lime-400 transition-shadow duration-150">
                            <option disabled selected>Loading materials...</option>
                        </select>
                    </div>

                    <div>
                        <label for="quantity" class="block text-sm font-bold text-black mb-1">2. Enter Quantity</label>
                         <div class="flex">
                             <input type="number" id="quantity" class="w-full border-2 border-black px-4 py-3 font-medium focus:outline-none focus:ring-4 focus:ring-offset-0 focus:ring-lime-400 transition-shadow duration-150" min="1" value="1" />
                             </div>
                    </div>

                    <div>
                        <label for="customerName" class="block text-sm font-bold text-black mb-1">3. Customer Name</label>
                        <input type="text" id="customerName" class="w-full border-2 border-black px-4 py-3 font-medium focus:outline-none focus:ring-4 focus:ring-offset-0 focus:ring-lime-400 transition-shadow duration-150" placeholder="Enter customer name" required />
                    </div>
                    </form>
            </div>

            <div class="space-y-6 flex flex-col">
                 <div class="border-4 border-black shadow-[6px_6px_0_0_#000] bg-lime-100 p-6 flex-grow flex flex-col justify-center items-center text-center">
                     <h3 class="text-lg font-bold text-gray-700 mb-2">ORDER TOTAL</h3>
                     <div id="priceDisplay" class="text-5xl md:text-6xl font-extrabold text-black mb-4">
                         Rp 0
                     </div>
                     <p class="text-sm text-gray-600">(Price calculated based on selection)</p>
                 </div>

                 <button type="submit" form="orderForm" class="w-full bg-lime-400 text-black font-bold py-4 px-6 border-4 border-black shadow-[6px_6px_0_0_#000] hover:bg-lime-300 hover:shadow-[8px_8px_0_0_#000] active:shadow-[3px_3px_0_0_#000] active:translate-x-[3px] active:translate-y-[3px] transition-all duration-150 text-center text-xl flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"> <path d="M3 3h2l.4 2M7 13h10l4-8H5m4 8V6m4 0v8" /> </svg>
                     PLACE ORDER
                 </button>

                 <div class="border-t-4 border-black pt-4">
                    <a href="/orders.html" class="group flex items-center justify-center gap-2 text-center text-black font-bold py-2 hover:text-lime-600 transition-colors duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"> <path d="M19 5H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z" /> <path d="M16 2v4M8 2v4M2 10h20"/> </svg>
                        View All Orders
                    </a>
                </div>
            </div>
        </div>
    </div> <div id="successToast" class="hidden fixed bottom-6 right-6 bg-green-400 text-black px-5 py-3 border-4 border-black shadow-[6px_6px_0_0_#000] flex items-center gap-3 z-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"> <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /> <polyline points="22 4 12 14.01 9 11.01" /> </svg>
        <span class="font-bold">Order placed successfully!</span>
    </div>


    <script>
        // --- JavaScript Logic (largely the same, just ensure selectors are correct) ---
        let materials = [];
        const materialSelect = document.getElementById('materialSelect');
        const quantityInput = document.getElementById('quantity');
        const customerNameInput = document.getElementById('customerName'); // Get customer name input
        const priceDisplay = document.getElementById('priceDisplay');
        const toast = document.getElementById('successToast');
        const orderForm = document.getElementById('orderForm'); // Get form reference
        const logoutButton = document.getElementById('logoutButton');

        async function fetchMaterials() {
            try {
                // Fetch materials from the API
                const response = await fetch('/materials');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                materials = await response.json();

                materialSelect.innerHTML = ''; // Clear loading or previous options

                if (materials.length === 0) {
                    const errorOpt = document.createElement('option');
                    errorOpt.disabled = true;
                    errorOpt.selected = true;
                    errorOpt.textContent = '-- No materials available --';
                    materialSelect.appendChild(errorOpt);
                    return;
                 }

                // Add default select option
                const defaultOpt = document.createElement('option');
                defaultOpt.disabled = true;
                defaultOpt.selected = true;
                defaultOpt.textContent = '-- Select Material --';
                materialSelect.appendChild(defaultOpt);

                // Populate materials
                materials.forEach(material => {
                    const opt = document.createElement('option');
                    opt.value = material.id;
                    opt.textContent = `${material.name}`; // Keep it clean
                    opt.dataset.price = material.unitPrice;
                    materialSelect.appendChild(opt);
                });

                updatePrice();
            } catch (error) { 
                console.error("Error fetching materials:", error);
                materialSelect.innerHTML = ''; // Clear loading
                const errorOpt = document.createElement('option');
                errorOpt.disabled = true;
                errorOpt.selected = true;
                errorOpt.textContent = '-- Error loading materials --';
                materialSelect.appendChild(errorOpt);
             }
        }

        function formatCurrency(amount) {
             // Format for Indonesian Rupiah
             return `Rp ${amount.toLocaleString('id-ID')}`;
        }

        function updatePrice() {
            const selectedOption = materialSelect.options[materialSelect.selectedIndex];
            const qty = parseInt(quantityInput.value) || 0;

            if (selectedOption && selectedOption.dataset.price && qty > 0) {
                const unitPrice = parseInt(selectedOption.dataset.price);
                const total = qty * unitPrice;
                priceDisplay.textContent = formatCurrency(total); // Use formatter
            } else {
                priceDisplay.textContent = formatCurrency(0); // Use formatter
            }
        }

        function showSuccessToast() {
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            window.location.href = '/login.html';
        }

        // --- Event Listeners ---
        materialSelect.addEventListener('change', updatePrice);
        quantityInput.addEventListener('input', updatePrice);
        logoutButton.addEventListener('click', handleLogout);

        orderForm.addEventListener('submit', async (e) => { // Listen on form element
            e.preventDefault();

            const materialId = parseInt(materialSelect.value);
            const quantity = parseInt(quantityInput.value);
            const customerName = customerNameInput.value.trim(); // Get customer name

            if (isNaN(materialId) || !materialSelect.options[materialSelect.selectedIndex].dataset.price || quantity < 1) {
                alert("Please select a valid material and enter a quantity of at least 1.");
                return;
            }
            if (!customerName) { // Validate customer name
                alert("Please enter the customer name.");
                return;
            }


            console.log('Submitting order:', { materialId, quantity, customerName }); // Include customer name in log

            try {
                console.log('Simulating API call...');
                // Replace dummy data with actual API call
                const response = await fetch('/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ materialId, quantity, customerName }), // Send customer name
                });

                if (response.ok) {
                    console.log('Order placed successfully!');
                    showSuccessToast();
                    // Reset form
                    quantityInput.value = 1;
                    customerNameInput.value = ''; // Clear customer name input
                    materialSelect.selectedIndex = 0; // Reset to "-- Select Material --"
                    updatePrice();
                } else {
                     const errorData = await response.json();
                     throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Order error:', error);
                alert(`Failed to place order: ${error.message}`);
            }
        });

        // Initial fetch
        fetchMaterials();

    </script>
</body>
</html>